(()=>{var e={237:(e,t,r)=>{const n={POSIntegrado:r(753),POSAutoservicio:r(621)};e.exports=n},937:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InterByteTimeoutParser=void 0;const n=r(203);class s extends n.Transform{maxBufferSize;currentPacket;interval;intervalID;constructor({maxBufferSize:e=65536,interval:t,...r}){if(super(r),!t)throw new TypeError('"interval" is required');if("number"!=typeof t||Number.isNaN(t))throw new TypeError('"interval" is not a number');if(t<1)throw new TypeError('"interval" is not greater than 0');if("number"!=typeof e||Number.isNaN(e))throw new TypeError('"maxBufferSize" is not a number');if(e<1)throw new TypeError('"maxBufferSize" is not greater than 0');this.maxBufferSize=e,this.currentPacket=[],this.interval=t}_transform(e,t,r){this.intervalID&&clearTimeout(this.intervalID);for(let t=0;t<e.length;t++)this.currentPacket.push(e[t]),this.currentPacket.length>=this.maxBufferSize&&this.emitPacket();this.intervalID=setTimeout(this.emitPacket.bind(this),this.interval),r()}emitPacket(){this.intervalID&&clearTimeout(this.intervalID),this.currentPacket.length>0&&this.push(Buffer.from(this.currentPacket)),this.currentPacket=[]}_flush(e){this.emitPacket(),e()}}t.InterByteTimeoutParser=s},631:e=>{"use strict";function t(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function r(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var n=2;e.exports=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var s,o;return s=e,o=[{key:"fromHexArray",value:function(e){return e.reduce((function(e,t){return null===e?t:e^t}),null)}},{key:"fromString",value:function(e){var t=e.split("").map((function(e){return e.charCodeAt(0)}));return this.fromHexArray(t)}},{key:"asStxEtx",value:function(e){"string"==typeof e&&(e=e.split("").map((function(e){return e.charCodeAt(0)}))),e[0]===n&&(e=e.splice(1)),3!==e[e.length-1]&&e.push(3);var r,s=this.fromHexArray(e);return[n].concat(function(e){if(Array.isArray(e))return t(e)}(r=e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(r)||function(e,r){if(e){if("string"==typeof e)return t(e,r);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?t(e,r):void 0}}(r)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(),[s])}}],null&&r(s.prototype,null),o&&r(s,o),e}()},515:(e,t,r)=>{const n=r(631);e.exports=n},621:(e,t,r)=>{const n=r(175);e.exports=class extends n{sale(e,t,r=!1,n=!1,s=null){e=e.toString().padStart(9,"0").slice(0,9),t=t.toString().padStart(6,"0").slice(0,6);let o=r?"1":"0",i=n?"1":"0";return this.send(`0200|${e}|${t}|${i}|${o}`,!0,s).then((e=>this.saleResponse(e)))}saleResponse(e){let t=e.split("|"),r=void 0!==t[5]?t[5].trim():null;return{functionCode:parseInt(t[0]),responseCode:parseInt(t[1]),responseMessage:this.getResponseMessage(parseInt(t[1])),commerceCode:parseInt(t[2]),terminalId:t[3],successful:0===parseInt(t[1]),ticket:t[4],authorizationCode:r,amount:parseInt(t[6]),last4Digits:""!==t[7]?parseInt(t[7]):null,operationNumber:t[8],cardType:t[9],accountingDate:t[10],accountNumber:t[11],cardBrand:t[12],realDate:t[13],realTime:t[14],voucher:t[15]?.match(/.{1,40}/g),shareType:t[16],sharesNumber:t[17],sharesAmount:t[18],sharesTypeComment:t[19]}}getLastSale(e=!1){let t=e?"1":"0";return this.send(`0250|${t}`).then((e=>{try{return this.saleResponse(e)}catch(e){throw new Error(e.getMessage())}}))}refund(){return this.send("1200").then((e=>{let t=e.split("|");return{functionCode:parseInt(t[0].replace(/\D+/g,"")),responseCode:parseInt(t[1]),commerceCode:parseInt(t[2]),terminalId:t[3],authorizationCode:t[4].trim(),operationId:t[5],responseMessage:this.getResponseMessage(parseInt(t[1])),successful:0===parseInt(t[1])}}))}closeDay(e=!1){let t=e?"1":"0";return this.send(`0500|${t}`).then((e=>{let t=e.split("|");return{functionCode:parseInt(t[0]),responseCode:parseInt(t[1]),commerceCode:parseInt(t[2]),terminalId:t[3],voucher:t[4]?.match(/.{1,40}/g),responseMessage:this.getResponseMessage(parseInt(t[1])),successful:0===parseInt(t[1])}}))}initialization(){return this.send("0070",!1)}initializationResponse(){return this.send("0080").then((e=>{let t=e.split("|");return{functionCode:parseInt(t[0]),responseCode:parseInt(t[1]),transactionDate:parseInt(t[2]),transactionTime:t[3],responseMessage:this.getResponseMessage(parseInt(t[1])),successful:0===parseInt(t[1])}}))}}},175:(e,t,r)=>{const n=r(515),{SerialPort:s}=r(425),o=r(434),{InterByteTimeoutParser:i}=r(937),a=r(411);e.exports=class extends o{constructor(){super(),this.currentPort=null,this.connected=!1,this.defaultBaudRate="POSAutoservicio"===this.constructor.name?19200:115200,this.ackTimeout=2e3,this.posTimeout=15e4,this.debugEnabled=!1,this.port=null,this.responseAsString=!0,this.waiting=!1,this.connecting=!1,this.responseCallback=function(){},this.ackCallback=function(){}}debug(...e){this.debugEnabled&&console.log(...e)}setDebug(e=!0){this.debugEnabled=e}getResponsesAsString(){this.responseAsString=!0}getResponsesAsHexArray(){this.responseAsString=!1}getConnectedPort(){return this.currentPort}isConnected(){return this.connected}raw_serial_port(){return this.port}raw_parser(){return this.parser}listPorts(){return s.list()}bufferToPrintableString(e){let t="";const r=e.length-1;return e.forEach(((e,n)=>{t+=n===r?`{0x${e.toString(16).padStart(2,"0")}}`:32<=e&&e<126?String.fromCharCode(e):`{0x${e.toString(16).padStart(2,"0")}}`})),t}connect(e=null,t=this.defaultBaudRate){return this.debug("Connecting to "+e+" @"+t),new Promise(((r,n)=>!0===this.connecting?n(new Error("Another connect command was already sent and it is still waiting")):this.connected?(this.debug("Trying to connect to a port while its already connected. Disconnecting... "),this.disconnect().then((()=>{r(this.connect(e,t))})).catch((()=>{r(this.connect(e,t))})),void(this.connecting=!1)):(this.connecting=!0,this.port=new s({path:e,baudRate:t,autoOpen:!1}),this.port.open((e=>{if(e)return this.debug("Error opening port",e),n(new Error("Could not open serial connection..."))})),this.parser=this.port.pipe(new i({interval:100})),this.parser.on("data",(e=>{this.debug(`IN <-- ${this.bufferToPrintableString(e)}`),this.itsAnACK(e)?"function"==typeof this.ackCallback&&this.ackCallback(e):(this.port.write(Buffer.from([6])),this.debug(`OUT --\x3e ${this.bufferToPrintableString([6])}`),"function"==typeof this.responseCallback&&this.responseCallback(e))})),this.port.on("open",(()=>{this.debug("Port opened"),this.connected=!0,this.poll().then((()=>{this.currentPort=e,this.emit("port_opened",this.currentPort),r(!0)})).catch((async e=>{this.connected=!1,this.waiting=!1,this.currentPort=null,this.port.isOpen&&await this.disconnect(),n(e)}))})),this.port.on("close",(()=>{this.debug("Port closed"),this.currentPort=null,this.waiting=!1,this.connected=!1,this.emit("port_closed")})),void(this.connecting=!1))))}disconnect(){return new Promise(((e,t)=>{this.port?.isOpen?this.port.close((r=>{r?(this.debug("Error closing port",r),t(r)):(this.debug("Port closed successfully"),e(!0))})):e(!0)}))}async autoconnect(e=this.defaultBaudRate){if(!0===this.connecting)return this.debug("It is already trying to connect. Please wait for it to finish"),!1;const t=await this.listPorts();for(let r of t){this.debug("Trying to connect to "+r.path);try{return await this.connect(r.path,e),this.connecting=!1,r}catch(e){this.debug("Error to connect "+r.path),console.log(e)}}return this.connecting=!1,this.debug("Autoconnection failed"),!1}send(e,t=!0,r=null){return new Promise(((s,o)=>{if(!this.connected)return o(new Error("You have to connect to a POS to send this message: "+e.toString()));if(!0===this.waiting)return o(new Error("Another message was already sent and it is still waiting for a response from the POS"));this.waiting=!0;let i=setTimeout((()=>{this.waiting=!1,clearTimeout(c),o(new Error("ACK has not been received in "+this.ackTimeout+" ms."))}),this.ackTimeout);this.ackCallback=()=>{clearTimeout(i),t||(this.waiting=!1,s(!0))};let a=Buffer.from(n.asStxEtx(e));this.debug(`OUT --\x3e ${this.bufferToPrintableString(a)}`),this.port.write(a,(function(e){e&&(this.debug("Error sending message",e),o(new Error("Failed to send message to POS.")))}));let c=setTimeout((()=>{this.waiting=!1,o(new Error(`Response of POS has not been received in ${this.posTimeout/1e3} seconds`))}),this.posTimeout);this.responseCallback=e=>{clearTimeout(c);let t=e;this.responseAsString&&(t=e.toString().slice(1,-2));let n=e.toString().slice(1,5);"0900"!==n?"0261"!==n?(this.waiting=!1,s(t,e)):"function"==typeof r&&r(t,e):"function"==typeof r&&r(this.intermediateResponse(t),e)}}))}getResponseMessage(e){return void 0!==a[e]?a[e]:null}itsAnACK(e){return 0===Buffer.compare(e,Buffer.from([6]))}poll(){return this.send("0100",!1)}loadKeys(){return this.send("0800").then((e=>{let t=e.split("|");return{functionCode:parseInt(t[0]),responseCode:parseInt(t[1]),commerceCode:parseInt(t[2]),terminalId:t[3],responseMessage:this.getResponseMessage(parseInt(t[1])),successful:0===parseInt(t[1])}}))}intermediateResponse(e){let t=e.split("|");return{responseCode:parseInt(t[1]),responseMessage:this.getResponseMessage(parseInt(t[1]))}}}},753:(e,t,r)=>{const n=r(175);e.exports=class extends n{closeDay(){return this.send("0500||").then((e=>{let t=e.split("|");return{functionCode:parseInt(t[0]),responseCode:parseInt(t[1]),commerceCode:parseInt(t[2]),terminalId:t[3],responseMessage:this.getResponseMessage(parseInt(t[1])),successful:0===parseInt(t[1])}}))}getLastSale(){return this.send("0250|").then((e=>{try{return this.saleResponse(e)}catch(e){throw new Error(e.getMessage())}}))}getTotals(){return this.send("0700||").then((e=>{let t=e.split("|");return{functionCode:parseInt(t[0]),responseCode:parseInt(t[1]),txCount:parseInt(t[2]),txTotal:parseInt(t[3]),responseMessage:this.getResponseMessage(parseInt(t[1])),successful:0===parseInt(t[1])}}))}salesDetail(e=!1){return new Promise(((t,r)=>{if("boolean"!=typeof e&&"string"!=typeof e)return r(new Error("printOnPos must be of type boolean."));"string"==typeof e&&(e="true"===e||"1"===e);let n=e?"0":"1",s=[],o=this.send(`0260|${n}|`,!e,function(e){let r=this.saleDetailResponse(e.toString().slice(1,-2));""!==r.authorizationCode&&null!==r.authorizationCode?s.push(r):t(s)}.bind(this));e&&t(o)}))}refund(e){if(void 0===e)throw new Error("Operation ID not provided when calling refund method.");return e=e.toString().slice(0,6),this.send(`1200|${e}|`).then((e=>{let t=e.split("|");return{functionCode:parseInt(t[0]),responseCode:parseInt(t[1]),commerceCode:parseInt(t[2]),terminalId:t[3],authorizationCode:t[4].trim(),operationId:t[5],responseMessage:this.getResponseMessage(parseInt(t[1])),successful:0===parseInt(t[1])}}))}changeToNormalMode(){return this.send("0300",!1)}sale(e,t,r=!1,n=null){e=e.toString().padStart(9,"0").slice(0,9),t=t.toString().padStart(6,"0").slice(0,6);let s=r?"1":"0";return this.send(`0200|${e}|${t}|||${s}`,!0,n).then((e=>this.saleResponse(e)))}multicodeSale(e,t,r=null,n=!1,s=null){e=e.toString().padStart(9,"0").slice(0,9),t=t.toString().padStart(6,"0").slice(0,6),r=null===r?"0":r;let o=n?"1":"0";return this.send(`0270|${e}|${t}|||${o}|${r}`,!0,s).then((e=>this.saleResponse(e)))}saleDetailResponse(e){let t=e.split("|"),r=void 0!==t[5]?t[5].trim():null;return{functionCode:parseInt(t[0]),responseCode:parseInt(t[1]),commerceCode:parseInt(t[2]),terminalId:t[3],responseMessage:this.getResponseMessage(parseInt(t[1])),successful:0===parseInt(t[1]),ticket:t[4],authorizationCode:r,amount:t[6],last4Digits:parseInt(t[7]),operationNumber:t[8],cardType:t[9],accountingDate:t[10],accountNumber:t[11],cardBrand:t[12],realDate:t[13],realTime:t[14],employeeId:t[15],tip:parseInt(t[16]),feeAmount:t[16],feeNumber:t[17]}}saleResponse(e){let t=e.split("|"),r=void 0!==t[5]?t[5].trim():null,n={functionCode:parseInt(t[0]),responseCode:parseInt(t[1]),commerceCode:parseInt(t[2]),terminalId:t[3],responseMessage:this.getResponseMessage(parseInt(t[1])),successful:0===parseInt(t[1]),ticket:t[4],authorizationCode:r,amount:parseInt(t[6]),sharesNumber:t[7],sharesAmount:t[8],last4Digits:""!==t[9]?parseInt(t[9]):null,operationNumber:t[10],cardType:t[11],accountingDate:t[12],accountNumber:t[13],cardBrand:t[14],realDate:t[15],realTime:t[16],employeeId:t[17],tip:""!==t[18]?parseInt(t[18]):null};return"0271"===t[0]&&(n.change=t[20],n.commerceCode=t[21]),n}}},411:e=>{e.exports={0:"Aprobado",1:"Rechazado",2:"Host no Responde",3:"Conexión Fallo",4:"Transacción ya Fue Anulada",5:"No existe Transacción para Anular",6:"Tarjeta no Soportada",7:"Transacción Cancelada desde el POS",8:"No puede Anular Transacción Debito",9:"Error Lectura Tarjeta",10:"Monto menor al mínimo permitido",11:"No existe venta",12:"Transacción No Soportada",13:"Debe ejecutar cierre ",14:"No hay Tono",15:"Archivo BITMAP.DAT no encontrado. Favor cargue",16:"Error Formato Respuesta del HOST",17:"Error en los 4 últimos dígitos.",18:"Menú invalido",19:"ERROR_TARJ_DIST",20:"Tarjeta Invalida",21:"Anulación no Permitida",22:"TIMEOUT",24:"Impresora Sin Papel",25:"Fecha Invalida",26:"Debe Cargar Llaves",27:"Debe Actualizar",60:"Error en Número de Cuotas",61:"Error en Armado de Solicitud",62:"Problema con el Pinpad interno",65:"Error al Procesar la Respuesta del Host",67:"Superó Número Máximo de Ventas, Debe Ejecutar Cierre",68:"Error Genérico, Falla al Ingresar Montos",70:"Error de formato Campo de Boleta MAX 6",71:"Error de Largo Campo de Impresión",72:"Error de Monto Venta, Debe ser Mayor que 0",73:"Terminal ID no configurado",74:"Debe Ejecutar CIERRE",75:"Comercio no tiene Tarjetas Configuradas",76:"Supero Número Máximo de Ventas, Debe Ejecutar CIERRE",77:"Debe Ejecutar Cierre",78:"Esperando Leer Tarjeta",79:"Solicitando Confirmar Monto",80:"Selección de Cuotas",81:"Solicitando Ingreso de Clave",82:"Enviando transacción al Host",83:"Seleccion menu credito/redcompra",84:"Opere tarjeta",85:"Seleccion de cuotas",86:"Ingreso de cuotas",87:"Confirmacion de cuotas",88:"Error Cantidad Cuotas",93:"Declinada",94:"Error al Procesar Respuesta",95:"Error al Imprimir TASA"}},425:e=>{"use strict";e.exports=require("serialport")},434:e=>{"use strict";e.exports=require("events")},203:e=>{"use strict";e.exports=require("stream")}},t={},r=function r(n){var s=t[n];if(void 0!==s)return s.exports;var o=t[n]={exports:{}};return e[n](o,o.exports,r),o.exports}(237);module.exports=r})();
//# sourceMappingURL=transbank.js.map